{% extends 'ebooks/_base.html' %}
{% load gravatar %}
{% load tagging_tags %}
{% load threadedcomments_tags  %}
{% load ratings %}
{% load range %}
{% load truncate %}

{% block title %}home{% endblock %}

{% block content %}
    <div class="row">
    <br>
    <div class="span10 well center book-info">
        <div class="row center">
            <div class="span2">
                {% if book.cover %}
                    <img src="{{ book.cover.url }}" width="160" />
                {% else %}
                    <img src="/images/book-no-cover.png" width="160" />
                {% endif %}
            </div>
            <div class="span8">
                <h3>{{ book.title }}</h3>
                <p>
                    {% if book.goodreads_id > 0 %}
                        gr rating: {{ book.metarating }} ({{ book.goodreads_num_votes }} votes)<br/>
                    {% endif %}
                    q rating: {{ book.rating }} (? votes)
                </p>
                <p class="btn-group">
                    <button class="btn" onclick="window.location.href='{% url books:email_kindle book.id %}'">K</button>
                    <button class="btn" href="{% url books:email_kindle book.id %}"><i class="icon-bookmark-empty"></i></button>
                    <button class="btn dropdown" href="{% url books:email_kindle book.id %}"><i class="icon-download-alt"></i></button>
                    <button class="btn btn-danger" href="{% url books:email_kindle book.id %}"><i class="icon-exclamation-sign"></i></button>
                </p>
                <p>
                    {% if book.formats|length > 0 %}
                        <h4>Formats</h4>
                        <ul class="book-formats">
                            {% csrf_token %}
                            {% for format in book.formats %}
                                <li class="{{ format.format }}"><i class="icon-check-empty"></i> <a href="{% url books:download_format format.download_key %}">{{ format.format }}</a> <input class="verify-toggle" id="{{ format.id }}" type="checkbox"{% if format.verified %} CHECKED{%endif%}> verified</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </p>
            </div>
            <div class="span10">
                <hr>
                <h4>Description:</h4>
                {{ book.description }}
                <hr>
                <p>
                    {% if book.also_downloaded|length > 0 %}
                        <h4>Others also downloaded...</h4>
                        <ul>
                            {% for b in book.also_downloaded %}
                                <li><a href="{% url books:book_info b.slug %}">{{ b.title|truncatechars:17 }}</a></li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </p>

                {% get_comment_list for book as comment_list %}

                <div id="discussion_list">
                    <h4>Discussion:</h4>
                    {% for comment in comment_list|fill_tree|annotate_tree %}

                        {% ifchanged comment.parent_id %}{% else %}
                            </li>
                        {% endifchanged %}

                        {% if not comment.open and not comment.close %}
                            </li>
                        {% endif %}

                        {% if comment.open %}
                            <ul>
                        {% endif %}

                    <li{% if comment.last %} class="last"{% endif %}>
                        <div class="comment">

                            <div class="activity-avatar">
                                {% gravatar comment.user 35 %}
                            </div>

                            <p class="comment-body">
                                {{ comment.comment }}
                            </p>
                            <a href="#" class="thread-reply-btn" id="comment_{{ comment.pk}}">reply</a>

                            <div id="reply-{{comment.pk}}"></div>
                        </div><!-- /.comment -->

                        {% if comment.added_path %} ADDED {% endif %}
                        {% for close in comment.close %}

                            </li>
                            </ul>
                        {% endfor %}
                    {% endfor %}
                </div><!-- /!discussion-list -->
                <!--- COMMENT FORM -->
                <div id="form_withparent" >
                    <form method="post" action="/comments/post/" class="comment-form">{% csrf_token %}
                        <h4>Leave a Comment:</h4>
                        {% get_comment_form for book as form %}
                        {% for field in form %}
                            {% if field.is_hidden %}
                                {{ field }}
                            {% else %}
                                {% ifnotequal field.name "comment" %}

                                    {% ifequal field.value None %}
                                        <input type="hidden" name="{{field.html_name}}" value="" />
                                    {% else %}
                                        <input type="hidden" name="{{field.html_name}}" value="{{field.value}}" />
                                    {% endifequal %}
                                {% else %}
                                    <p><textarea name="{{field.html_name}}"></textarea></p>

                                {% endifnotequal %}

                            {% endif %}
                        {% endfor %}
                        <input type="hidden" name="next" value="{{ request.path }}" />
                        <p><input type="submit" name="post" value="Ответить!" class="submit-large" /></p>
                    </form>
                </div>
                <!---#END COMMENT FORM -->
            </div>
        </div>
    </div>
    </div>
{% endblock %}

{% block below_footer %}

{% endblock %}
